<!-- advice.wxml -->
<view class="advice-container">
  <!-- é¡¶éƒ¨å¡ç‰‡ï¼šç”¨æˆ·å¥åº·æ‘˜è¦ -->
  <view class="user-card card">
    <view class="user-info">
      <view class="user-avatar">
        <!-- ä½¿ç”¨æ–‡å­—å¤´åƒæ›¿ä»£å›¾ç‰‡ -->
        <text class="avatar-text">{{userInfo.username ? userInfo.username[0] : 'U'}}</text>
      </view>
      <view class="user-details">
        <text class="user-name">{{userInfo.username || 'ç”¨æˆ·'}}</text>
        <text class="user-level">{{userInfo.level || 'åˆçº§è·‘è€…'}}</text>
      </view>
    </view>
    <view class="health-summary">
      <view class="health-item">
        <text class="health-value">{{physicalStats.health_index || 0}}</text>
        <text class="health-label">å¥åº·æŒ‡æ•°</text>
      </view>
      <view class="health-item">
        <text class="health-value">{{physicalStats.weekly_distance || 0}}km</text>
        <text class="health-label">æœ¬å‘¨é‡Œç¨‹</text>
      </view>
      <view class="health-item">
        <text class="health-value">{{physicalStats.avg_heart_rate || 0}}</text>
        <text class="health-label">å¹³å‡å¿ƒç‡</text>
      </view>
    </view>
  </view>

  <!-- åˆ‡æ¢æ ‡ç­¾ -->
  <view class="tab-container">
    <view class="tab {{activeTab === 'training' ? 'active' : ''}}" bindtap="switchTab" data-tab="training">
      <text>è®­ç»ƒè®¡åˆ’</text>
    </view>
    <view class="tab {{activeTab === 'nutrition' ? 'active' : ''}}" bindtap="switchTab" data-tab="nutrition">
      <text>è¥å…»å»ºè®®</text>
    </view>
    <view class="tab-slider" style="left: {{activeTab === 'training' ? '0' : '50%'}}"></view>
  </view>

  <!-- è®­ç»ƒè®¡åˆ’å»ºè®® -->
  <view class="advice-content {{activeTab === 'training' ? 'show' : 'hide'}}">
    <view wx:if="{{fitnessAdviceError}}" class="error-container">
      <text class="error-text">{{fitnessAdviceError}}</text>
      <button class="retry-button" bindtap="refreshAdvice">é‡è¯•</button>
    </view>
    <block wx:else>
      <view class="advice-card card">
        <view class="card-header">
          <text class="card-title">æœ¬å‘¨è®­ç»ƒè®¡åˆ’</text>
          <text class="card-date">{{currentDate}}</text>
        </view>
        <view class="advice-list">
          <view wx:if="{{!fitnessAdvice.weekly_plan || fitnessAdvice.weekly_plan.length === 0}}" class="no-data">
            <text>æš‚æ— è®­ç»ƒè®¡åˆ’å»ºè®®</text>
          </view>
          <view wx:else>
            <view class="advice-item" wx:for="{{fitnessAdvice.weekly_plan}}" wx:key="day">
              <view class="advice-day">{{item.day}}</view>
              <view class="advice-detail">
                <view class="advice-type">{{item.workout_type}}</view>
                <view class="advice-desc">{{item.description}}</view>
                <view class="advice-metrics">
                  <text>{{item.distance}}km</text>
                  <text class="dot">Â·</text>
                  <text>{{item.duration}}åˆ†é’Ÿ</text>
                  <text class="dot">Â·</text>
                  <text>{{item.intensity}}</text>
                </view>
              </view>
            </view>
          </view>
        </view>
      </view>

      <view class="advice-card card">
        <view class="card-header">
          <text class="card-title">è®­ç»ƒå»ºè®®</text>
        </view>
        <view class="advice-content-text">
          <rich-text nodes="{{fitnessAdviceNodes}}"></rich-text>
        </view>
        <view class="advice-tips">
          <view class="tip-item" wx:for="{{fitnessAdvice.tips || []}}" wx:key="index">
            <view class="tip-icon">ğŸ’¡</view>
            <view class="tip-text">{{item}}</view>
          </view>
        </view>
      </view>
    </block>
  </view>

  <!-- è¥å…»å»ºè®® -->
  <view class="advice-content {{activeTab === 'nutrition' ? 'show' : 'hide'}}">
    <view wx:if="{{nutritionAdviceError}}" class="error-container">
      <text class="error-text">{{nutritionAdviceError}}</text>
      <button class="retry-button" bindtap="refreshAdvice">é‡è¯•</button>
    </view>
    <block wx:else>
      <view class="advice-card card">
        <view class="card-header">
          <text class="card-title">è¥å…»æ‘„å…¥å»ºè®®</text>
        </view>
        <view class="nutrition-summary">
          <view class="nutrition-item">
            <view class="nutrition-value">{{nutritionAdvice.calories || 2000}}kcal</view>
            <view class="nutrition-label">æ¯æ—¥çƒ­é‡</view>
          </view>
          <view class="nutrition-item">
            <view class="nutrition-value">{{nutritionAdvice.protein || 100}}g</view>
            <view class="nutrition-label">è›‹ç™½è´¨</view>
          </view>
          <view class="nutrition-item">
            <view class="nutrition-value">{{nutritionAdvice.carbs || 250}}g</view>
            <view class="nutrition-label">ç¢³æ°´</view>
          </view>
          <view class="nutrition-item">
            <view class="nutrition-value">{{nutritionAdvice.fat || 60}}g</view>
            <view class="nutrition-label">è„‚è‚ª</view>
          </view>
        </view>
      </view>

      <view class="advice-card card">
        <view class="card-header">
          <text class="card-title">é¥®é£Ÿå»ºè®®</text>
        </view>
        <view class="advice-content-text">
          <rich-text nodes="{{nutritionAdviceNodes}}"></rich-text>
        </view>
        
        <view class="meal-plans">
          <view class="meal-section">
            <view class="meal-title">æ—©é¤</view>
            <view class="meal-items">
              <text>{{nutritionAdvice.breakfast || 'å…¨éº¦é¢åŒ…ã€é¸¡è›‹ã€ç‰›å¥¶å’Œæ°´æœ'}}</text>
            </view>
          </view>
          <view class="meal-section">
            <view class="meal-title">åˆé¤</view>
            <view class="meal-items">
              <text>{{nutritionAdvice.lunch || 'ç³™ç±³é¥­ã€é¸¡èƒ¸è‚‰ã€è”¬èœæ²™æ‹‰'}}</text>
            </view>
          </view>
          <view class="meal-section">
            <view class="meal-title">æ™šé¤</view>
            <view class="meal-items">
              <text>{{nutritionAdvice.dinner || 'é±¼è‚‰ã€è”¬èœã€å°‘é‡ç¢³æ°´åŒ–åˆç‰©'}}</text>
            </view>
          </view>
          <view class="meal-section">
            <view class="meal-title">åŠ é¤</view>
            <view class="meal-items">
              <text>{{nutritionAdvice.snacks || 'åšæœã€é…¸å¥¶æˆ–æ°´æœ'}}</text>
            </view>
          </view>
        </view>

        <view class="advice-tips">
          <view class="tip-item" wx:for="{{nutritionAdvice.tips || []}}" wx:key="index">
            <view class="tip-icon">ğŸ’¡</view>
            <view class="tip-text">{{item}}</view>
          </view>
        </view>
      </view>
    </block>
  </view>

  <!-- åˆ·æ–°æŒ‰é’® -->
  <view class="refresh-button" bindtap="refreshAdvice" hidden="{{isLoading}}">
    <text class="refresh-icon">â†»</text>
    <text>æ›´æ–°å»ºè®®</text>
  </view>

  <!-- åœ¨é¡µé¢åº•éƒ¨æ·»åŠ è®¾ç½®APIå¯†é’¥æŒ‰é’® -->
  <view class="settings-section">
    <button class="btn-secondary" bindtap="setApiKey">è®¾ç½®DeepSeek APIå¯†é’¥</button>
  </view>
</view>

<!-- åŠ è½½æç¤º -->
<view class="loading-container" wx:if="{{isLoading}}">
  <view class="loading-spinner"></view>
  <text class="loading-text">åŠ è½½ä¸­...</text>
</view> 