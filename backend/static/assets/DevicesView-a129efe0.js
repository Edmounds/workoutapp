import{r as Ue,s as $e,t as Se,v as ze,w as Fe,x as Ie,y as Ne}from"./index-ff651f95.js";import{u as qe,i as Oe,a as Ae,b as Te,c as Ee,d as We,H as Be}from"./index.esm.min-fe8a6091.js";import{_ as Je,y as Le,r as s,c as Re,o as He,a as u,b as z,f as O,g as t,h as l,e as d,i as n,t as f,m as K,d as Me,u as Pe}from"./index-13a3803f.js";const je={class:"text-center"},Ge={class:"text-h4 font-weight-bold"},Ke={class:"text-center"},Qe={class:"text-h4 font-weight-bold"},Xe={class:"text-center"},Ye={class:"text-h4 font-weight-bold"},Ze={class:"text-center"},he={class:"text-h4 font-weight-bold"},el={key:0,style:{height:"250px"}},ll={__name:"DevicesView",setup(tl){qe([Oe,Ae,Te,Ee,We]),Le();const F=s(!1),Q=s(""),X=s("success"),r=(o,e="success")=>{Q.value=o,X.value=e,F.value=!0},Y=s([]),c=s(null),A=s(!1),T=s(""),oe=[{title:"设备ID",key:"device_id"},{title:"设备名称",key:"device_name"},{title:"设备类型",key:"device_type"},{title:"状态",key:"status"},{title:"用户",key:"username",align:"center"},{title:"最后活跃",key:"last_active"},{title:"操作",key:"actions",sortable:!1,align:"center"}],ne=[{text:"未绑定",value:0},{text:"已绑定",value:1},{text:"已禁用",value:2}],k=s(!1),E=s(!1),Z=s(null),m=s({device_id:"",secret:"",device_name:"",device_type:"Wristband"}),V=s(!1),w=s(!1),W=s(!1),h=s(null),v=s({}),D=s(!1),B=s(""),J=s(!1),I=s(!1),ee=s(""),L=s(""),N=s(!1),se=s(null),R=s(""),H=s(!1),ue=Re(()=>{if(!c.value||!c.value.by_type)return{};const o=c.value.by_type.map(e=>({name:e.device_type,value:e.count}));return{tooltip:{trigger:"item",formatter:"{a} <br/>{b}: {c} ({d}%)"},legend:{orient:"horizontal",bottom:0,data:o.map(e=>e.name)},series:[{name:"设备类型",type:"pie",radius:["40%","70%"],avoidLabelOverlap:!1,itemStyle:{borderRadius:10,borderColor:"#fff",borderWidth:2},label:{show:!1,position:"center"},emphasis:{label:{show:!0,fontSize:16,fontWeight:"bold"}},labelLine:{show:!1},data:o}]}});He(async()=>{await C(),await q()});async function C(){A.value=!0;try{const o=await Ue();o.code===200?Y.value=o.data.devices||[]:r(o.message||"获取设备列表失败","error")}catch(o){console.error("获取设备列表错误:",o),r("获取设备列表失败: "+(o.message||"未知错误"),"error")}finally{A.value=!1}}async function q(){try{const o=await $e();o.code===200&&(c.value=o.data)}catch(o){console.error("获取设备统计数据错误:",o)}}function re(){m.value={device_id:"",secret:"",device_name:"",device_type:"Wristband"},k.value=!0,setTimeout(()=>{var o;(o=Z.value)==null||o.reset()},0)}async function de(){if(E.value){V.value=!0;try{const o=await Se(m.value);o.code===201?(r("设备添加成功","success"),k.value=!1,await C(),await q()):r(o.message||"设备添加失败","error")}catch(o){console.error("添加设备错误:",o),r("添加设备失败: "+(o.message||"未知错误"),"error")}finally{V.value=!1}}}function ie(o){v.value={...o},w.value=!0,setTimeout(()=>{var e;(e=h.value)==null||e.resetValidation()},0)}async function ve(){if(W.value){V.value=!0;try{const o=await ze(v.value.device_id,{device_name:v.value.device_name,device_type:v.value.device_type,status:v.value.status});o.code===200?(r("设备信息更新成功","success"),w.value=!1,await C()):r(o.message||"设备信息更新失败","error")}catch(o){console.error("更新设备信息错误:",o),r("更新设备信息失败: "+(o.message||"未知错误"),"error")}finally{V.value=!1}}}function ce(o){B.value=o.device_id,D.value=!0}async function me(){J.value=!0;try{const o=await Fe(B.value);o.code===200?(r("设备删除成功","success"),D.value=!1,await C(),await q()):r(o.message||"设备删除失败","error")}catch(o){console.error("删除设备错误:",o),r("删除设备失败: "+(o.message||"未知错误"),"error")}finally{J.value=!1}}async function fe(o){try{const e=await Ie(o.device_id);e.code===200?(ee.value=o.device_id,L.value=e.data.new_secret,I.value=!0):r(e.message||"重置设备密钥失败","error")}catch(e){console.error("重置设备密钥错误:",e),r("重置设备密钥失败: "+(e.message||"未知错误"),"error")}}function _e(){navigator.clipboard.writeText(L.value).then(()=>{r("密钥已复制到剪贴板","success")}).catch(o=>{console.error("复制密钥失败:",o),r("复制密钥失败","error")})}async function pe(){let o;try{if(o=JSON.parse(R.value),!Array.isArray(o))throw new Error("数据必须是数组格式")}catch(e){r("无效的JSON格式: "+e.message,"error");return}H.value=!0;try{const e=await Ne({devices:o});e.code===201?(r(`批量添加成功: 成功${e.data.success}个, 失败${e.data.failed}个`,"success"),N.value=!1,await C(),await q()):r(e.message||"批量添加设备失败","error")}catch(e){console.error("批量添加设备错误:",e),r("批量添加设备失败: "+(e.message||"未知错误"),"error")}finally{H.value=!1}}function ye(o){switch(o){case 0:return"未绑定";case 1:return"已绑定";case 2:return"已禁用";default:return"未知"}}function ge(o){switch(o){case 0:return"grey";case 1:return"success";case 2:return"error";default:return"grey"}}function xe(o){return o?new Date(o).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}):""}return(o,e)=>{const b=u("v-spacer"),_=u("v-text-field"),i=u("v-btn"),p=u("v-card-title"),Ve=u("v-chip"),M=u("v-icon"),P=u("v-tooltip"),be=u("v-data-table"),y=u("v-card-text"),g=u("v-card"),x=u("v-col"),j=u("v-row"),le=u("v-skeleton-loader"),G=u("v-form"),U=u("v-card-actions"),$=u("v-dialog"),ke=u("v-select"),te=u("v-alert"),we=u("v-textarea"),De=u("v-snackbar"),Ce=u("v-container");return z(),O(Ce,{fluid:""},{default:t(()=>[l(j,null,{default:t(()=>[l(x,{cols:"12"},{default:t(()=>[l(g,null,{default:t(()=>[l(p,{class:"d-flex align-center"},{default:t(()=>[e[25]||(e[25]=d("span",{class:"text-h5"},"设备管理",-1)),l(b),l(_,{modelValue:T.value,"onUpdate:modelValue":e[0]||(e[0]=a=>T.value=a),"append-icon":"mdi-magnify",label:"搜索设备","single-line":"","hide-details":"",density:"compact",class:"mx-2",style:{"max-width":"300px"}},null,8,["modelValue"]),l(i,{color:"primary","prepend-icon":"mdi-plus",onClick:re},{default:t(()=>e[24]||(e[24]=[n(" 添加设备 ")])),_:1,__:[24]})]),_:1,__:[25]}),l(y,null,{default:t(()=>[l(be,{headers:oe,items:Y.value,search:T.value,loading:A.value,"items-per-page":10,"items-per-page-options":[5,10,20,50],class:"elevation-1"},{"item.status":t(({item:a})=>[l(Ve,{color:ge(a.status),size:"small",label:""},{default:t(()=>[n(f(ye(a.status)),1)]),_:2},1032,["color"])]),"item.last_active":t(({item:a})=>[n(f(a.last_active?xe(a.last_active):"从未活跃"),1)]),"item.actions":t(({item:a})=>[l(P,{text:"编辑设备"},{activator:t(({props:S})=>[l(i,K({icon:"",size:"small",color:"primary"},S,{onClick:ae=>ie(a)}),{default:t(()=>[l(M,null,{default:t(()=>e[26]||(e[26]=[n("mdi-pencil")])),_:1,__:[26]})]),_:2},1040,["onClick"])]),_:2},1024),l(P,{text:"重置密钥"},{activator:t(({props:S})=>[l(i,K({icon:"",size:"small",color:"warning",class:"mx-1"},S,{onClick:ae=>fe(a)}),{default:t(()=>[l(M,null,{default:t(()=>e[27]||(e[27]=[n("mdi-key-variant")])),_:1,__:[27]})]),_:2},1040,["onClick"])]),_:2},1024),l(P,{text:"删除设备"},{activator:t(({props:S})=>[l(i,K({icon:"",size:"small",color:"error"},S,{onClick:ae=>ce(a)}),{default:t(()=>[l(M,null,{default:t(()=>e[28]||(e[28]=[n("mdi-delete")])),_:1,__:[28]})]),_:2},1040,["onClick"])]),_:2},1024)]),_:1},8,["items","search","loading"])]),_:1})]),_:1})]),_:1})]),_:1}),l(j,{class:"mt-4"},{default:t(()=>[l(x,{cols:"12",md:"6"},{default:t(()=>[l(g,null,{default:t(()=>[l(p,null,{default:t(()=>e[29]||(e[29]=[n("设备状态统计")])),_:1,__:[29]}),l(y,null,{default:t(()=>[c.value?(z(),O(j,{key:0},{default:t(()=>[l(x,{cols:"6",md:"3"},{default:t(()=>[d("div",je,[d("div",Ge,f(c.value.total_devices),1),e[30]||(e[30]=d("div",{class:"text-caption text-grey"},"总设备数",-1))])]),_:1}),l(x,{cols:"6",md:"3"},{default:t(()=>[d("div",Ke,[d("div",Qe,f(c.value.bound_devices),1),e[31]||(e[31]=d("div",{class:"text-caption text-grey"},"已绑定",-1))])]),_:1}),l(x,{cols:"6",md:"3"},{default:t(()=>[d("div",Xe,[d("div",Ye,f(c.value.unbound_devices),1),e[32]||(e[32]=d("div",{class:"text-caption text-grey"},"未绑定",-1))])]),_:1}),l(x,{cols:"6",md:"3"},{default:t(()=>[d("div",Ze,[d("div",he,f(c.value.active_devices_today),1),e[33]||(e[33]=d("div",{class:"text-caption text-grey"},"今日活跃",-1))])]),_:1})]),_:1})):(z(),O(le,{key:1,type:"article"}))]),_:1})]),_:1})]),_:1}),l(x,{cols:"12",md:"6"},{default:t(()=>[l(g,null,{default:t(()=>[l(p,null,{default:t(()=>e[34]||(e[34]=[n("设备类型分布")])),_:1,__:[34]}),l(y,null,{default:t(()=>[c.value&&c.value.by_type?(z(),Me("div",el,[l(Pe(Be),{option:ue.value,autoresize:""},null,8,["option"])])):(z(),O(le,{key:1,type:"image",height:"250"}))]),_:1})]),_:1})]),_:1})]),_:1}),l($,{modelValue:k.value,"onUpdate:modelValue":e[7]||(e[7]=a=>k.value=a),"max-width":"600px"},{default:t(()=>[l(g,null,{default:t(()=>[l(p,null,{default:t(()=>e[35]||(e[35]=[n("添加新设备")])),_:1,__:[35]}),l(y,null,{default:t(()=>[l(G,{ref_key:"addForm",ref:Z,modelValue:E.value,"onUpdate:modelValue":e[5]||(e[5]=a=>E.value=a)},{default:t(()=>[l(_,{modelValue:m.value.device_id,"onUpdate:modelValue":e[1]||(e[1]=a=>m.value.device_id=a),label:"设备ID",required:"",rules:[a=>!!a||"设备ID必填"]},null,8,["modelValue","rules"]),l(_,{modelValue:m.value.secret,"onUpdate:modelValue":e[2]||(e[2]=a=>m.value.secret=a),label:"设备密钥",required:"",rules:[a=>!!a||"设备密钥必填"]},null,8,["modelValue","rules"]),l(_,{modelValue:m.value.device_name,"onUpdate:modelValue":e[3]||(e[3]=a=>m.value.device_name=a),label:"设备名称",required:"",rules:[a=>!!a||"设备名称必填"]},null,8,["modelValue","rules"]),l(_,{modelValue:m.value.device_type,"onUpdate:modelValue":e[4]||(e[4]=a=>m.value.device_type=a),label:"设备类型",required:"",rules:[a=>!!a||"设备类型必填"]},null,8,["modelValue","rules"])]),_:1},8,["modelValue"])]),_:1}),l(U,null,{default:t(()=>[l(b),l(i,{color:"grey-darken-1",variant:"text",onClick:e[6]||(e[6]=a=>k.value=!1)},{default:t(()=>e[36]||(e[36]=[n("取消")])),_:1,__:[36]}),l(i,{color:"primary",variant:"text",onClick:de,loading:V.value},{default:t(()=>e[37]||(e[37]=[n("保存")])),_:1,__:[37]},8,["loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),l($,{modelValue:w.value,"onUpdate:modelValue":e[14]||(e[14]=a=>w.value=a),"max-width":"600px"},{default:t(()=>[l(g,null,{default:t(()=>[l(p,null,{default:t(()=>e[38]||(e[38]=[n("编辑设备")])),_:1,__:[38]}),l(y,null,{default:t(()=>[l(G,{ref_key:"editForm",ref:h,modelValue:W.value,"onUpdate:modelValue":e[12]||(e[12]=a=>W.value=a)},{default:t(()=>[l(_,{modelValue:v.value.device_id,"onUpdate:modelValue":e[8]||(e[8]=a=>v.value.device_id=a),label:"设备ID",disabled:""},null,8,["modelValue"]),l(_,{modelValue:v.value.device_name,"onUpdate:modelValue":e[9]||(e[9]=a=>v.value.device_name=a),label:"设备名称",required:"",rules:[a=>!!a||"设备名称必填"]},null,8,["modelValue","rules"]),l(_,{modelValue:v.value.device_type,"onUpdate:modelValue":e[10]||(e[10]=a=>v.value.device_type=a),label:"设备类型",required:"",rules:[a=>!!a||"设备类型必填"]},null,8,["modelValue","rules"]),l(ke,{modelValue:v.value.status,"onUpdate:modelValue":e[11]||(e[11]=a=>v.value.status=a),label:"设备状态",items:ne,"item-title":"text","item-value":"value",required:""},null,8,["modelValue"])]),_:1},8,["modelValue"])]),_:1}),l(U,null,{default:t(()=>[l(b),l(i,{color:"grey-darken-1",variant:"text",onClick:e[13]||(e[13]=a=>w.value=!1)},{default:t(()=>e[39]||(e[39]=[n("取消")])),_:1,__:[39]}),l(i,{color:"primary",variant:"text",onClick:ve,loading:V.value},{default:t(()=>e[40]||(e[40]=[n("保存")])),_:1,__:[40]},8,["loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),l($,{modelValue:I.value,"onUpdate:modelValue":e[16]||(e[16]=a=>I.value=a),"max-width":"500px"},{default:t(()=>[l(g,null,{default:t(()=>[l(p,null,{default:t(()=>e[41]||(e[41]=[n("设备密钥已重置")])),_:1,__:[41]}),l(y,null,{default:t(()=>[d("p",null,[e[42]||(e[42]=n("设备ID: ")),d("strong",null,f(ee.value),1)]),d("p",null,[e[43]||(e[43]=n("新密钥: ")),d("strong",null,f(L.value),1)]),l(te,{type:"warning",density:"compact",class:"mt-2"},{default:t(()=>e[44]||(e[44]=[n(" 请立即保存此密钥，关闭此窗口后将无法再次查看！ ")])),_:1,__:[44]})]),_:1}),l(U,null,{default:t(()=>[l(b),l(i,{color:"primary",variant:"text",onClick:_e},{default:t(()=>e[45]||(e[45]=[n("复制密钥")])),_:1,__:[45]}),l(i,{color:"grey-darken-1",variant:"text",onClick:e[15]||(e[15]=a=>I.value=!1)},{default:t(()=>e[46]||(e[46]=[n("关闭")])),_:1,__:[46]})]),_:1})]),_:1})]),_:1},8,["modelValue"]),l($,{modelValue:D.value,"onUpdate:modelValue":e[18]||(e[18]=a=>D.value=a),"max-width":"400px"},{default:t(()=>[l(g,null,{default:t(()=>[l(p,null,{default:t(()=>e[47]||(e[47]=[n("确认删除")])),_:1,__:[47]}),l(y,null,{default:t(()=>[e[48]||(e[48]=n(" 您确定要删除设备 ")),d("strong",null,f(B.value),1),e[49]||(e[49]=n(" 吗？此操作不可撤销。 "))]),_:1,__:[48,49]}),l(U,null,{default:t(()=>[l(b),l(i,{color:"grey-darken-1",variant:"text",onClick:e[17]||(e[17]=a=>D.value=!1)},{default:t(()=>e[50]||(e[50]=[n("取消")])),_:1,__:[50]}),l(i,{color:"error",variant:"text",onClick:me,loading:J.value},{default:t(()=>e[51]||(e[51]=[n("删除")])),_:1,__:[51]},8,["loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),l($,{modelValue:N.value,"onUpdate:modelValue":e[21]||(e[21]=a=>N.value=a),"max-width":"700px"},{default:t(()=>[l(g,null,{default:t(()=>[l(p,null,{default:t(()=>e[52]||(e[52]=[n("批量添加设备")])),_:1,__:[52]}),l(y,null,{default:t(()=>[l(G,{ref_key:"batchForm",ref:se},{default:t(()=>[l(we,{modelValue:R.value,"onUpdate:modelValue":e[19]||(e[19]=a=>R.value=a),label:"设备数据 (JSON格式)",hint:"请输入JSON格式的设备数据数组","persistent-hint":"",rows:"10"},null,8,["modelValue"]),l(te,{type:"info",density:"compact",class:"mt-2"},{default:t(()=>e[53]||(e[53]=[n(' 格式示例: [{"device_id": "DEV001", "secret": "secret1", "device_name": "设备1", "device_type": "Wristband"}, ...] ')])),_:1,__:[53]})]),_:1},512)]),_:1}),l(U,null,{default:t(()=>[l(b),l(i,{color:"grey-darken-1",variant:"text",onClick:e[20]||(e[20]=a=>N.value=!1)},{default:t(()=>e[54]||(e[54]=[n("取消")])),_:1,__:[54]}),l(i,{color:"primary",variant:"text",onClick:pe,loading:H.value},{default:t(()=>e[55]||(e[55]=[n("添加")])),_:1,__:[55]},8,["loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),l(De,{modelValue:F.value,"onUpdate:modelValue":e[23]||(e[23]=a=>F.value=a),color:X.value,timeout:3e3,location:"top"},{actions:t(()=>[l(i,{variant:"text",onClick:e[22]||(e[22]=a=>F.value=!1)},{default:t(()=>e[56]||(e[56]=[n(" 关闭 ")])),_:1,__:[56]})]),default:t(()=>[n(f(Q.value)+" ",1)]),_:1},8,["modelValue","color"])]),_:1})}}},sl=Je(ll,[["__scopeId","data-v-883e76d5"]]);export{sl as default};
